<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaok√© - Explorez votre collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-black text-white">
    <div id="app">
        <!-- Header -->
        <header class="bg-black/50 backdrop-blur-md border-b border-purple-500/30 sticky top-0 z-40">
            <div class="max-w-6xl mx-auto px-4 py-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">üéµ</div>
                        <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                            KARAOK√â
                        </h1>
                    </div>
                    <button id="settingsBtn" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Param√®tres">
                        ‚öôÔ∏è
                    </button>
                </div>
                <p class="text-purple-200 text-sm">
                    <span id="songCount">Explorez votre collection de chansons</span>
                </p>
            </div>
        </header>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal-overlay fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-gradient-to-br from-purple-900 to-blue-900 border border-purple-500/30 rounded-lg p-6 max-w-md w-full max-h-96 overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">‚öôÔ∏è Configuration</h2>
                    <button id="closeSettingsBtn" class="p-1 hover:bg-white/10 rounded transition-colors">
                        ‚úï
                    </button>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-purple-300">
                            üìã Google Sheet ID
                        </label>
                        <input
                            type="text"
                            id="sheetId"
                            placeholder="1mN8kX5vY9qWpZaB2cC3dD4eE5fF6gG7hH8iI9jJ0kK"
                            class="w-full px-3 py-2 bg-white/10 border border-purple-500/30 rounded focus:outline-none focus:border-purple-500 text-white text-sm"
                        />
                        <p class="text-xs text-purple-400 mt-1">
                            Trouvez-le dans l'URL de votre Google Sheet entre /d/ et /edit
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 text-purple-300">
                            üîë Cl√© API Google
                        </label>
                        <input
                            type="password"
                            id="apiKey"
                            placeholder="AIzaSyD_wkl8vB2c3vH9jK4lM5nO6pQ7rS8tU9vW"
                            class="w-full px-3 py-2 bg-white/10 border border-purple-500/30 rounded focus:outline-none focus:border-purple-500 text-white text-sm"
                        />
                        <p class="text-xs text-purple-400 mt-1">
                            Cr√©ez-la sur <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer" class="text-purple-300 hover:underline">Google Cloud Console</a>
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 text-purple-300">
                            üìë Nom de la feuille
                        </label>
                        <input
                            type="text"
                            id="sheetName"
                            placeholder="Feuille1"
                            value="Feuille1"
                            class="w-full px-3 py-2 bg-white/10 border border-purple-500/30 rounded focus:outline-none focus:border-purple-500 text-white text-sm"
                        />
                        <p class="text-xs text-purple-400 mt-1">
                            Voir les onglets en bas de votre Google Sheet
                        </p>
                    </div>
                </div>

                <div class="space-y-3">
                    <button
                        id="saveConfigBtn"
                        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg font-semibold transition-all"
                    >
                        üíæ Enregistrer
                    </button>
                    <button
                        id="cancelConfigBtn"
                        class="w-full bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg font-semibold transition-all"
                    >
                        Annuler
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- Configuration Required -->
            <div id="configRequired" class="bg-blue-500/20 border border-blue-500 rounded-lg p-6 mb-8 text-center">
                <div class="text-4xl mb-4">‚öôÔ∏è</div>
                <h2 class="text-xl font-bold mb-2">Configuration requise</h2>
                <p class="text-blue-200 mb-4">
                    Cliquez sur l'ic√¥ne d'engrenage en haut √† droite pour configurer votre Google Sheet
                </p>
                <button
                    id="openSettingsBtn"
                    class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-6 py-2 rounded-lg font-semibold"
                >
                    ‚öôÔ∏è Configurer maintenant
                </button>
            </div>

            <!-- Tabs -->
            <div id="tabsContainer" class="hidden flex flex-wrap gap-2 mb-8">
                <button class="tab-btn active flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-purple-500 to-pink-500 shadow-lg shadow-purple-500/50" data-tab="all">
                    üéµ Toutes les chansons
                </button>
                <button class="tab-btn flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-white/10 hover:bg-white/20 border border-purple-500/30" data-tab="duo">
                    üë• Duos
                </button>
                <button class="tab-btn flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-white/10 hover:bg-white/20 border border-purple-500/30" data-tab="top">
                    ‚≠ê Top chansons
                </button>
            </div>

            <!-- Search Bar -->
            <div id="searchContainer" class="hidden mb-8">
                <div class="relative">
                    <span class="absolute left-4 top-4 text-purple-400">üîç</span>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Rechercher par nom de chanson ou artiste..."
                        class="w-full pl-12 pr-4 py-3 bg-white/10 border border-purple-500/30 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 text-white placeholder-purple-300"
                    />
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden flex justify-center items-center py-12">
                <div class="animate-spin text-3xl">üéµ</div>
                <p class="ml-3 text-purple-300">Chargement des chansons...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-red-500/20 border border-red-500 rounded-lg p-4 mb-8">
                <p id="errorMessage" class="text-red-200 font-semibold mb-2"></p>
                <p class="text-red-300 text-sm">
                    V√©rifiez que :
                </p>
                <ul class="text-red-300 text-sm mt-2 list-disc list-inside space-y-1">
                    <li>Votre cl√© API est correcte</li>
                    <li>Votre Sheet ID est correct</li>
                    <li>Votre Google Sheet est rendu PUBLIC</li>
                    <li>Le nom de la feuille correspond (v√©rifiez les espaces)</li>
                    <li>L'API Google Sheets est activ√©e</li>
                </ul>
                <button
                    id="editConfigBtn"
                    class="mt-4 bg-red-500 hover:bg-red-600 px-4 py-2 rounded text-sm font-semibold transition-colors"
                >
                    Modifier la configuration
                </button>
            </div>

            <!-- Results Count -->
            <div id="resultsCount" class="hidden mb-6 text-purple-300">
                <span id="resultText"></span>
            </div>

            <!-- Songs Grid -->
            <div id="songsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <div class="text-4xl mb-4 opacity-50">üéµ</div>
                <p class="text-purple-300 text-lg">Aucune chanson trouv√©e</p>
                <p class="text-purple-400 text-sm mt-2">Essayez une autre recherche ou changez de cat√©gorie</p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="border-t border-purple-500/30 mt-12 bg-black/50">
            <div class="max-w-6xl mx-auto px-4 py-6 text-center text-purple-300 text-sm">
                Bienvenue au karaok√© ! Chantez vos meilleures chansons üé§
            </div>
        </footer>
    </div>

    <script>
        // √âtat global
        let allSongs = [];
        let filteredSongs = [];
        let currentTab = 'all';
        let config = {
            sheetId: '',
            apiKey: '',
            sheetName: 'Feuille1'
        };

        // √âl√©ments du DOM
        const settingsBtn = document.getElementById('settingsBtn');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const cancelConfigBtn = document.getElementById('cancelConfigBtn');
        const editConfigBtn = document.getElementById('editConfigBtn');
        const sheetIdInput = document.getElementById('sheetId');
        const apiKeyInput = document.getElementById('apiKey');
        const sheetNameInput = document.getElementById('sheetName');
        const searchInput = document.getElementById('searchInput');
        const songsGrid = document.getElementById('songsGrid');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const configRequired = document.getElementById('configRequired');
        const tabsContainer = document.getElementById('tabsContainer');
        const searchContainer = document.getElementById('searchContainer');
        const resultsCount = document.getElementById('resultsCount');
        const resultText = document.getElementById('resultText');
        const emptyState = document.getElementById('emptyState');
        const songCount = document.getElementById('songCount');

        // Charger la configuration depuis localStorage
        function loadConfig() {
            const saved = localStorage.getItem('karaokeConfig');
            if (saved) {
                config = JSON.parse(saved);
                sheetIdInput.value = config.sheetId;
                apiKeyInput.value = config.apiKey;
                sheetNameInput.value = config.sheetName;
                return true;
            }
            return false;
        }

        // Sauvegarder la configuration
        function saveConfig() {
            config.sheetId = sheetIdInput.value.trim();
            config.apiKey = apiKeyInput.value.trim();
            config.sheetName = sheetNameInput.value.trim();
            localStorage.setItem('karaokeConfig', JSON.stringify(config));
            closeModal();
            fetchSongs();
        }

        // Ouvrir/Fermer le modal
        function openModal() {
            settingsModal.classList.add('active');
        }

        function closeModal() {
            settingsModal.classList.remove('active');
        }

        // R√©cup√©rer les chansons via le backend Vercel
        async function fetchSongs() {
            if (!config.sheetId || !config.apiKey) {
                return;
            }

            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            configRequired.classList.add('hidden');

            try {
                // D√©terminer l'URL de base (localhost ou Vercel)
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const baseUrl = isLocal ? 'http://localhost:3000' : window.location.origin;
                
                const url = `${baseUrl}/api/sheets?sheetId=${encodeURIComponent(config.sheetId)}&apiKey=${encodeURIComponent(config.apiKey)}&sheetName=${encodeURIComponent(config.sheetName)}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    handleError(data.error);
                } else if (data.values && data.values.length > 0) {
                    const rows = data.values.slice(1);
                    allSongs = rows
                        .map((row) => ({
                            nom: row[0] || '',
                            artiste: row[1] || '',
                            duo: row[2]?.toLowerCase() === 'oui',
                            top: row[3]?.toLowerCase() === 'oui',
                            genre: row[4] || '',
                            difficulte: row[5] || '',
                        }))
                        .filter(song => song.nom);

                    songCount.textContent = `${allSongs.length} chansons disponibles`;
                    tabsContainer.classList.remove('hidden');
                    searchContainer.classList.remove('hidden');
                    configRequired.classList.add('hidden');
                    filterSongs();
                    renderSongs();
                    loadingState.classList.add('hidden');
                } else {
                    handleError('Aucune donn√©e trouv√©e');
                }
            } catch (err) {
                handleError('Erreur de connexion: ' + err.message);
                console.error('Erreur:', err);
            }
        }

        // G√©rer les erreurs
        function handleError(message) {
            let friendlyMessage = message;
            if (message.includes('Invalid API key')) {
                friendlyMessage = '‚ùå Cl√© API invalide. V√©rifiez votre configuration.';
            } else if (message.includes('Requested range contains a blank range')) {
                friendlyMessage = '‚ùå Le nom de la feuille est incorrect. V√©rifiez dans votre Google Sheet.';
            } else if (message.includes('permission')) {
                friendlyMessage = '‚ùå Le Sheet n\'est pas public. Rendez-le public dans les param√®tres de partage.';
            }
            
            errorMessage.textContent = friendlyMessage;
            errorState.classList.remove('hidden');
            loadingState.classList.add('hidden');
            tabsContainer.classList.add('hidden');
            searchContainer.classList.add('hidden');
        }

        // Filtrer les chansons
        function filterSongs() {
            filteredSongs = allSongs;

            if (currentTab === 'duo') {
                filteredSongs = filteredSongs.filter(song => song.duo);
            } else if (currentTab === 'top') {
                filteredSongs = filteredSongs.filter(song => song.top);
            }

            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredSongs = filteredSongs.filter(song =>
                    song.nom.toLowerCase().includes(searchTerm) ||
                    song.artiste.toLowerCase().includes(searchTerm)
                );
            }
        }

        // Afficher les chansons
        function renderSongs() {
            filterSongs();

            // Mettre √† jour le compte
            const count = filteredSongs.length;
            resultText.textContent = `${count} chanson${count !== 1 ? 's' : ''} trouv√©e${count !== 1 ? 's' : ''}`;
            resultsCount.classList.remove('hidden');

            // Afficher/masquer les √©l√©ments
            if (filteredSongs.length === 0) {
                songsGrid.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                songsGrid.innerHTML = filteredSongs.map((song, index) => `
                    <div class="group bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur border border-purple-500/30 rounded-lg p-4 hover:from-purple-500/40 hover:to-pink-500/40 transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/30">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white group-hover:text-purple-200 transition-colors">
                                    ${song.nom}
                                </h3>
                                <p class="text-purple-300 text-sm">${song.artiste}</p>
                            </div>
                            ${song.top ? '<span class="text-2xl ml-2 flex-shrink-0">‚≠ê</span>' : ''}
                        </div>

                        <div class="flex flex-wrap gap-2 mt-3">
                            ${song.duo ? '<span class="inline-flex items-center gap-1 bg-blue-500/40 px-2 py-1 rounded text-xs font-semibold text-blue-200">üë• Duo</span>' : ''}
                            ${song.genre ? `<span class="inline-block bg-purple-500/40 px-2 py-1 rounded text-xs text-purple-200">${song.genre}</span>` : ''}
                            ${song.difficulte ? `<span class="inline-block bg-orange-500/40 px-2 py-1 rounded text-xs text-orange-200">${song.difficulte}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        // Event Listeners - Settings
        settingsBtn.addEventListener('click', openModal);
        openSettingsBtn.addEventListener('click', openModal);
        closeSettingsBtn.addEventListener('click', closeModal);
        saveConfigBtn.addEventListener('click', saveConfig);
        cancelConfigBtn.addEventListener('click', closeModal);
        editConfigBtn.addEventListener('click', openModal);

        // Event Listeners - Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500', 'shadow-lg', 'shadow-purple-500/50');
                    b.classList.add('bg-white/10', 'border', 'border-purple-500/30');
                });
                e.target.classList.add('active', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500', 'shadow-lg', 'shadow-purple-500/50');
                e.target.classList.remove('bg-white/10', 'border', 'border-purple-500/30');
                currentTab = e.target.dataset.tab;
                searchInput.value = '';
                renderSongs();
            });
        });

        // Event Listeners - Search
        searchInput.addEventListener('input', renderSongs);

        // Fermer le modal en cliquant en dehors
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeModal();
            }
        });

        // Initialiser l'app
        if (loadConfig()) {
            configRequired.classList.add('hidden');
            fetchSongs();
        } else {
            configRequired.classList.remove('hidden');
        }
    </script>
</body>
</html>
